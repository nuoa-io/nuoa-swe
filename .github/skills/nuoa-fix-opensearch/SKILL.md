---
name: nuoa-fix-opensearch
description: Fixes OpenSearch domain conflicts by checking indexes, comparing with expected configuration, and reindexing tables
---

# NUOA Fix OpenSearch Domain Skill

## Description

This skill automatically detects and fixes OpenSearch domain conflicts by:
1. Fetching the OpenSearch domain from AWS (auto-selects the single domain)
2. Comparing actual indexes with expected configuration from resource files
3. Reporting mismatches as bugs
4. Removing conflicting index properties from CloudFormation
5. Triggering tenant-pipeline stack to rebuild
6. Reindexing affected DynamoDB tables using version increments

It combines domain validation, infrastructure management, and data reindexing in a single automated workflow.

## Use Cases

- Trigger full table reindexing for OpenSearch
- Force version updates after schema changes
- Test DynamoDB streams and triggers
- Migrate data with version constraints
- Validate optimistic locking implementation

## Prerequisites

- Python 3.9+ with required packages (see Installation)
- AWS credentials configured via profiles (nuoa-beta, nuoa-prod, nuoa)
- Permissions:
  - OpenSearch: `es:DescribeDomain`, `es:ListDomainNames`, `es:ESHttpGet`
  - CloudFormation: `cloudformation:DescribeStackResources`
  - CodePipeline: `codepipeline:StartPipelineExecution`, `codepipeline:GetPipeline`
  - DynamoDB: Read/write access to tenant tables
- DynamoDB tables with `versionId` field
- CloudFormation stack deployed (default: `stack-pooled`)

## Installation

Install required dependencies:

```bash
cd repos/nuoa-io-backend-tenant-services/src/python/scripts
pip install -r requirements.txt
```

Required packages:
- `boto3>=1.26.0` - AWS SDK
- `opensearch-py>=2.0.0` - OpenSearch Python client
- `requests-aws4auth>=1.1.0` - AWS request signing

## Usage

### Dry Run (Recommended First)
```bash
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --stack-name stack-pooled \
  --dry-run
```

### Live Execution (Beta Environment)
```bash
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --stack-name stack-pooled
```

### Production Environment
```bash
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-prod \
  --stack-name stack-pooled
```

### Quick Check (Dev Environment)
```bash
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa \
  --dry-run
```

## Parameters

- `--profile` (required): AWS profile name (nuoa-beta, nuoa-prod, nuoa)
  - Determines which environment to check
  - Used for all AWS API calls
  
- `--stack-name` (optional): CloudFormation stack name (default: stack-pooled)
  - Name of the tenant services stack
  - Used to identify resources to modify
  
- `--dry-run` (optional): Run in dry-run mode without making changes
  - Checks indexes and reports issues
  - Does not modify CloudFormation or trigger pipelines
  - Does not reindex tables
  - Always recommended for first run

## How It Works

### Phase 1: Discovery & Validation
1. **Get OpenSearch Domain**: Automatically discovers and selects the single OpenSearch domain in the account
2. **Fetch Indexes**: Lists all indexes currently in the domain (excludes system indexes starting with `.`)
3. **Load Expected Configuration**: Reads index mappings from resource files generated by `DefaultFormListTest.java`
4. **Compare Indexes**: Identifies missing indexes (should exist) and extra indexes (shouldn't exist)

### Phase 2: Issue Reporting
5. **Generate Bug Report**: If mismatches found, logs detailed report with:
   - Missing indexes that need to be created
   - Extra indexes that shouldn't exist
   - Current vs expected state

### Phase 3: Remediation (if not dry-run)
6. **Remove Conflicting Resources**: 
   - Identifies CloudFormation custom resources for index creation
   - Provides instructions to remove them from CDK code
   - Note: Direct removal requires manual CDK code update
   
7. **Trigger Pipeline**: Starts `tenant-pipeline-{stage}` to rebuild infrastructure
   - Creates missing indexes
   - Updates existing indexes to match schema
   
8. **Wait & Recheck**: Waits 60 seconds, then rechecks indexes to verify fixes

### Phase 4: Reindexing
9. **Reindex Tables**: For each missing/fixed index:
   - Maps index name to DynamoDB table (e.g., `activity-index` → `Activity-beta-pooled`)
   - Calls `increase_version_of_table.py` to increment all record versions
   - Triggers DynamoDB streams to reindex into OpenSearch

## Expected Indexes

The script validates the following indexes (defined in `DefaultFormListTest.java`):

| Index Name | DynamoDB Table | Description |
|------------|----------------|-------------|
| `activity-index` | `Activity-{stage}-pooled` | Activity data and emissions |
| `pcf-index` | `Pcf-{stage}-pooled` | Product Carbon Footprint records |
| `pcf-request-index` | `PcfRequest-{stage}-pooled` | PCF requests from suppliers |
| `product-line-index` | `ProductLine-{stage}-pooled` | Product line definitions |
| `product-line-input-index` | `ProductLineInput-{stage}-pooled` | Product line inputs |
| `product-line-output-index` | `ProductLineOutput-{stage}-pooled` | Product line outputs |
| `report-index` | `Report-{stage}-pooled` | Sustainability reports |
| `entity-index` | `Entity-{stage}-pooled` | Organization entities |
| `initiative-index` | `Initiative-{stage}-pooled` | Reduction initiatives |
| `target-index` | `Target-{stage}-pooled` | Emission reduction targets |
| `option-index` | `Option-{stage}-pooled` | Configuration options |

Each index mapping is loaded from `/src/java/lambdas/src/main/resources/{index-name}`

## Dry Run Mode

When `--dry-run` is enabled:
- Fetches and lists all indexes from OpenSearch
- Compares with expected configuration
- Reports any mismatches as bugs
- Does NOT:
  - Modify CloudFormation resources
  - Trigger pipelines
  - Reindex any tables
  - Make any changes to AWS resources
  
**Always run with `--dry-run` first** to understand what changes will be made.

## Performance Considerations

### Scan Performance
- Full table scan reads all items
- Consumes read capacity units (RCU)
- May take significant time for large tables
- Consider using on-demand billing during operation

### Write Performance
- Each update consumes write capacity units (WCU)
- Updates are sequential, not batched
- Failed optimistic lock checks retry automatically
- Monitor CloudWatch metrics during operation

### Cost Optimization
- Use dry-run to estimate RCU/WCU consumption
- Run during off-peak hours for large tables
- Consider temporary capacity increases for provisioned tables
- Monitor costs in AWS Cost Explorer

## Output

### Successful Run (All Indexes Match)
```
[2026-02-02 10:30:15] [INFO] Starting OpenSearch Domain Fix Script
[2026-02-02 10:30:15] [INFO] Profile: nuoa-beta
[2026-02-02 10:30:15] [INFO] Stack: stack-pooled
[2026-02-02 10:30:15] [INFO] Stage: beta
[2026-02-02 10:30:16] [INFO] Selected domain: nuoa-opensearch-domain-beta
[2026-02-02 10:30:16] [INFO] Domain endpoint: https://search-nuoa-xxx.us-east-1.es.amazonaws.com
[2026-02-02 10:30:17] [INFO] Found 11 indexes: ['activity-index', 'pcf-index', ...]
[2026-02-02 10:30:17] [INFO] Loading expected index mappings from resource files...
[2026-02-02 10:30:18] [INFO] Comparing indexes...
[2026-02-02 10:30:18] [INFO] All indexes match expected configuration!
[2026-02-02 10:30:18] [INFO] SUCCESS: All indexes match expected configuration!
```

### Run with Issues Found
```
[2026-02-02 10:30:15] [INFO] Starting OpenSearch Domain Fix Script
...
[2026-02-02 10:30:18] [WARNING] Missing indexes: {'target-index', 'option-index'}
[2026-02-02 10:30:18] [WARNING] Extra/unexpected indexes: {'old-legacy-index'}
[2026-02-02 10:30:18] [ERROR] BUG REPORT: Index Mismatch Detected!
[2026-02-02 10:30:18] [ERROR] Missing indexes (should exist): {'target-index', 'option-index'}
[2026-02-02 10:30:18] [ERROR] Extra indexes (should not exist): {'old-legacy-index'}

--- Fixing Missing Indexes ---
[2026-02-02 10:30:19] [WARNING] To remove these resources, you need to:
[2026-02-02 10:30:19] [WARNING] 1. Comment out or remove the corresponding addIndex() calls
[2026-02-02 10:30:19] [WARNING] 2. Deploy the updated stack with: cdk deploy
[2026-02-02 10:30:20] [INFO] Pipeline triggered successfully! Execution ID: abc-123-def-456
[2026-02-02 10:30:20] [INFO] Monitor at: https://us-east-1.console.aws.amazon.com/...

--- Reindexing Tables ---
[2026-02-02 10:31:21] [INFO] Reindexing table: Target-beta-pooled
[2026-02-02 10:32:35] [INFO] Scanned and updated 523 rows.
```

## Error Handling

### No OpenSearch domains found
- Verify AWS credentials and profile
- Check region configuration
- Ensure OpenSearch domain is deployed

### Required packages not installed
- Install dependencies: `pip install -r requirements.txt`
- Packages: `boto3`, `opensearch-py`, `requests-aws4auth`

### Pipeline not found
- Pipeline name format: `tenant-pipeline-{stage}`
- Verify pipeline exists in CodePipeline console
- Check stage inference from profile name
- Manual trigger command provided as fallback

### Resource file not found
- Ensure resource files exist in `/src/java/lambdas/src/main/resources/`
- Generate them by running `DefaultFormListTest.java` test
- Files should match index names (e.g., `activity-index`, `pcf-index`)

### CloudFormation access errors
- Verify IAM permissions for CloudFormation operations
- Check stack name is correct (default: `stack-pooled`)
- Ensure profile has access to the target account

### Reindex failures
- Check DynamoDB table exists and matches naming pattern
- Verify `versionId` field exists in all records
- Review DynamoDB stream configuration
- Check Lambda functions processing streams are healthy

## DynamoDB Streams Integration

Incrementing versions triggers DynamoDB Streams:
- Each update generates a MODIFY event
- Stream consumers (Lambda) process updates
- Useful for triggering reindexing pipelines
- Can trigger OpenSearch synchronization

## Reindexing Workflow

Typical reindexing workflow:
1. Run dry-run to estimate impact
2. Verify stream consumers are ready
3. Execute live update
4. Monitor stream processing in CloudWatch
5. Verify reindexing completion in OpenSearch

## Safety Recommendations

1. **Always start with dry-run** to validate setup
2. **Backup data** before live execution on critical tables
3. **Monitor costs** during execution on large tables
4. **Check capacity** before running on provisioned tables
5. **Verify stream consumers** are functioning correctly

## Examples

### Routine Health Check
```bash
# Check beta environment for issues
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --dry-run

# Check prod environment for issues
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-prod \
  --dry-run
```

### Post-Deployment Verification
```bash
# After deploying new index changes
cd repos/nuoa-io-backend-tenant-services

# Deploy CDK stack
cdk deploy --profile nuoa-beta

# Verify indexes are correct
python src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --dry-run
```

### Fix Detected Issues
```bash
# First, dry-run to see what will be fixed
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --stack-name stack-pooled \
  --dry-run

# Review output, then run without dry-run to fix
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-beta \
  --stack-name stack-pooled
```

### Production Fix (Careful!)
```bash
# Always dry-run in prod first
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-prod \
  --dry-run

# If confident, apply fixes during maintenance window
python repos/nuoa-io-backend-tenant-services/src/python/scripts/fix_opensearch_domain.py \
  --profile nuoa-prod
```

## Troubleshooting

### Script can't connect to OpenSearch
- Check network connectivity and security groups
- Verify IAM role has OpenSearch access
- Ensure VPC configuration allows access
- Review OpenSearch domain access policies

### Indexes keep appearing as mismatched
- Verify resource files are up to date
- Run `DefaultFormListTest.java` to regenerate mappings
- Check for manual index modifications in OpenSearch
- Review recent CDK deployments

### Pipeline trigger fails
- Verify pipeline exists: `aws codepipeline list-pipelines --profile {profile}`
- Check IAM permissions for CodePipeline
- Ensure pipeline name follows convention: `tenant-pipeline-{stage}`
- Manually trigger via AWS Console as fallback

### Reindexing takes very long
- Normal for large tables (full scan + updates)
- Monitor CloudWatch metrics for progress
- Check DynamoDB stream lag
- Verify Lambda functions aren't throttling
- Consider running during off-peak hours

### Index still missing after pipeline completes
- Check CloudFormation stack events for errors
- Verify CDK code has `addIndex()` call for the index
- Review Lambda logs for custom resource execution
- Check OpenSearch cluster health and capacity
- Manually trigger index creation via OpenSearch API

## Architecture & Integration

### Component Diagram
```
┌─────────────────────────────────────────────────────────────┐
│                  fix_opensearch_domain.py                    │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   OpenSearch │  │ CloudFormation│  │ CodePipeline │     │
│  │    Client    │  │    Client    │  │    Client    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         │                  │                  │             │
└─────────┼──────────────────┼──────────────────┼─────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────┐  ┌──────────────┐  ┌──────────────┐
│   OpenSearch    │  │     Stack    │  │   Pipeline   │
│     Domain      │  │   stack-     │  │   tenant-    │
│                 │  │    pooled    │  │  pipeline-   │
└─────────────────┘  └──────────────┘  │   {stage}    │
          │                  │          └──────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────┐
│        Reindex: increase_version_of_table.py        │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │  DynamoDB Tables │
              │  - Activity      │
              │  - Pcf           │
              │  - Report        │
              │  - ...           │
              └──────────────────┘
                         │
                         │ (DynamoDB Streams)
                         ▼
              ┌──────────────────┐
              │   Lambda Stream  │
              │   Processors     │
              └──────────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │   Reindex to     │
              │   OpenSearch     │
              └──────────────────┘
```

### Integration Points

**1. Resource File Generation**
- Source: `DefaultFormListTest.java` (generates index mappings)
- Location: `/src/java/lambdas/src/main/resources/{index-name}`
- Format: Key-value pairs of field names and types

**2. CDK Stack Integration**
- File: `opensearch-construct.ts`
- Method: `addIndex(indexId, indexName, indexMappings)`
- Generates CloudFormation custom resources for index creation

**3. Pipeline Integration**
- Naming: `tenant-pipeline-{stage}`
- Trigger: Rebuilds infrastructure and recreates indexes
- Monitoring: Returns execution ID for tracking

**4. DynamoDB Stream Integration**
- Reindexing triggers version increments
- DynamoDB Streams emit MODIFY events
- Lambda processors consume streams and update OpenSearch

### When to Use This Skill

| Scenario | Use Case |
|----------|----------|
| **Post-Deployment** | Verify indexes match after CDK deployment |
| **Schema Changes** | After updating field mappings in Java code |
| **Domain Issues** | OpenSearch domain returning errors |
| **Index Corruption** | Indexes missing or have wrong schema |
| **Health Check** | Routine validation in CI/CD pipeline |
| **Disaster Recovery** | Rebuild indexes after domain restore |
| **Migration** | Moving between OpenSearch versions |

### Agents Integration

Agents can use this skill to:
1. **Automated Health Checks**: Schedule periodic index validation
2. **Post-Deployment Verification**: Validate after infrastructure changes
3. **Issue Detection & Remediation**: Detect and auto-fix index problems
4. **Incident Response**: First step in OpenSearch troubleshooting
5. **Change Management**: Verify index consistency across environments

## Related Skills & Tools

### Related Scripts
- `increase_version_of_table.py` - DynamoDB reindexing (called automatically)
- `DefaultFormListTest.java` - Generate index mapping files
- `opensearch-construct.ts` - CDK construct for OpenSearch infrastructure

### Related Skills
- `nuoa-call-tenant` - Verify data after reindexing via API calls
- `nuoa-update-lambda` - Deploy stream consumer updates
- `nuoa-deploy-cdk` - Deploy infrastructure changes
- `data-modeling` - Design indexed data models
- `aws-solution-architect` - OpenSearch and DynamoDB best practices
- `observability-design` - Monitor reindexing and index health
- `incident-response` - Troubleshoot OpenSearch failures

### AWS Services Used
- **OpenSearch Service** - Search domain and index management
- **CloudFormation** - Infrastructure as code
- **CodePipeline** - CI/CD automation
- **DynamoDB** - Data storage with streams
- **Lambda** - Stream processing for reindexing
- **IAM** - Access control and permissions

## Best Practices

### Operational Best Practices
1. **Always run dry-run first** before making changes
2. **Schedule fixes during maintenance windows** for production
3. **Monitor CloudWatch logs** during reindexing
4. **Verify pipeline completion** before considering fix complete
5. **Test in lower environments** before production
6. **Document any manual interventions** required

### Development Best Practices
1. **Keep resource files in sync** with Java code
2. **Run DefaultFormListTest** after form/field changes
3. **Update expected indexes list** when adding new indexes
4. **Version control all mapping files**
5. **Include index verification** in CI/CD pipeline

### Security Best Practices
1. **Use least-privilege IAM roles**
2. **Rotate AWS credentials regularly**
3. **Audit script execution** via CloudTrail
4. **Restrict production access**
5. **Review pipeline changes** before triggering

## Monitoring & Observability

### Key Metrics to Monitor
- **OpenSearch Cluster Health**: Green/Yellow/Red status
- **Index Count**: Should match expected count (11 indexes)
- **DynamoDB Stream Lag**: Should process quickly
- **Lambda Errors**: Check stream processor errors
- **Reindex Progress**: Track via script output

### CloudWatch Dashboards
Create dashboards to monitor:
- OpenSearch index operations (IndexingRate, SearchRate)
- DynamoDB table metrics (ConsumedReadCapacity, ConsumedWriteCapacity)
- Lambda function metrics (Invocations, Errors, Duration)
- Pipeline execution status

### Alerts to Configure
- OpenSearch cluster status != Green
- DynamoDB stream iterator age > 5 minutes
- Lambda function errors > threshold
- Pipeline execution failures

## Performance Considerations

### Reindexing Performance
- **Small tables** (<10K items): ~1-2 minutes
- **Medium tables** (10K-100K items): ~5-15 minutes
- **Large tables** (>100K items): ~30+ minutes

Factors affecting performance:
- DynamoDB table size
- Write capacity/throttling
- Lambda concurrency limits
- OpenSearch cluster capacity

### Cost Optimization
- Run during off-peak hours to reduce contention
- Use on-demand DynamoDB billing during reindex
- Monitor and right-size OpenSearch instance types
- Batch operations where possible

## Support & Maintenance

### When to Run This Script
- **Weekly**: Health check in dev/beta environments
- **Post-Deployment**: After any CDK stack changes
- **On-Demand**: When search functionality reports errors
- **Incident Response**: First diagnostic step for OpenSearch issues

### Maintenance Tasks
- Update expected indexes list when adding new indexes
- Regenerate resource files after schema changes
- Review and update table mapping as resources added
- Keep dependencies up to date (boto3, opensearch-py)

### Getting Help
- Check script output for detailed error messages
- Review CloudWatch logs for Lambda and OpenSearch
- Examine CloudFormation stack events
- Consult AWS OpenSearch documentation
- Review related SKILL.md files for integration points
